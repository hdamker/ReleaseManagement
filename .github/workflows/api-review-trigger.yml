# .github/workflows/api-review-trigger.yml
# 
# CAMARA API Review Trigger Workflow (Dynamic Discovery)
# 
# Purpose: Entry point for automated CAMARA API compliance reviews. Can be triggered by:
#   - Issue comments starting with "/rc-api-review" (extracts PR URL from issue description)
#   - Manual workflow dispatch with custom parameters
# 
# New Features:
#   - Dynamic discovery of reusable workflow location
#   - Support for deployment in any CAMARA repository
#   - Results posted to current repository (not ReleaseManagement)
#   - Fork-friendly with fallback to official tooling
# 
# This workflow validates inputs, discovers tooling location, and calls the reusable review workflow.
# 
# Deploy this file to: ANY CAMARA repository .github/workflows/ directory
# Results will be posted to: Issues in the SAME repository

name: 'CAMARA API Review Trigger'

on:
  workflow_dispatch:
    inputs:
      pull_request_url:
        description: 'Full URL of the pull request to review (e.g., https://github.com/camaraproject/QualityOnDemand/pull/123)'
        required: true
        type: string
      review_type:
        description: 'Type of review to perform'
        required: true
        default: 'release-candidate'
        type: choice
        options:
          - 'release-candidate'
          - 'wip'
      commonalities_version:
        description: 'CAMARA Commonalities version (currently only 0.6 is supported)'
        required: false
        default: '0.6'
        type: choice
        options:
          - '0.6'
          - '0.7'
          - '1.0'
  issue_comment:
    types: [created]

jobs:
  check-comment-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      trigger_command: ${{ steps.check.outputs.trigger_command }}
      comment_context: ${{ steps.check.outputs.comment_context }}
      pull_request_url: ${{ steps.extract.outputs.pull_request_url }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
      pr_number: ${{ steps.extract.outputs.pr_number }}
      review_type: ${{ steps.extract.outputs.review_type }}
      commonalities_version: ${{ steps.extract.outputs.commonalities_version }}
      is_main_branch: ${{ steps.extract.outputs.is_main_branch }}
      target_branch: ${{ steps.extract.outputs.target_branch }}
      target_repo: ${{ steps.extract.outputs.target_repo }}
    steps:
      - name: Check Comment Trigger
        id: check
        run: |
          # Check if this is a comment event
          if [[ "${{ github.event_name }}" != "issue_comment" ]]; then
            echo "‚ÑπÔ∏è Not a comment event, skipping comment processing"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Determine comment context (issue or pull request)
          if [[ -n "${{ github.event.issue.pull_request.url }}" ]]; then
            COMMENT_CONTEXT="pull_request"
            echo "üí¨ Comment context: Pull Request #${{ github.event.issue.number }}"
          else
            COMMENT_CONTEXT="issue"
            echo "üí¨ Comment context: Issue #${{ github.event.issue.number }}"
          fi
          
          # Use jq to safely extract comment body and get first line only
          COMMENT_FIRST_LINE=$(echo '${{ toJSON(github.event.comment.body) }}' | jq -r '. | split("\n")[0]')
          
          echo "üí¨ Comment first line: '$COMMENT_FIRST_LINE'"
          
          # Check for trigger commands
          if [[ "$COMMENT_FIRST_LINE" == "/rc-api-review"* ]]; then
            echo "‚úÖ Release candidate review trigger detected: /rc-api-review"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "trigger_command=rc-api-review" >> $GITHUB_OUTPUT
            echo "comment_context=$COMMENT_CONTEXT" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT_FIRST_LINE" == "/wip-api-review"* ]]; then
            echo "‚úÖ Work-in-progress review trigger detected: /wip-api-review"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "trigger_command=wip-api-review" >> $GITHUB_OUTPUT
            echo "comment_context=$COMMENT_CONTEXT" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è Comment does not start with a recognized trigger command, skipping"
            echo "Recognized commands: /rc-api-review, /wip-api-review"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract Review Parameters
        id: extract
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "üîç Extracting review parameters..."
          
          TRIGGER_COMMAND="${{ steps.check.outputs.trigger_command }}"
          COMMENT_CONTEXT="${{ steps.check.outputs.comment_context }}"
          
          echo "Command: $TRIGGER_COMMAND"
          echo "Context: $COMMENT_CONTEXT"
          
          if [[ "$COMMENT_CONTEXT" == "issue" ]]; then
            echo "üìã Processing issue comment..."
            
            if [[ "$TRIGGER_COMMAND" == "wip-api-review" ]]; then
              echo "üîÑ WIP review in issue - targeting main branch"
              
              # For WIP reviews in issues, target the main branch of current repository
              # First, get the default branch (fallback to 'main' if not available)
              DEFAULT_BRANCH=$(gh api repos/${{ github.repository }} --jq '.default_branch' 2>/dev/null || echo "main")
              
              # Construct URL for current repo's main branch (simulating a PR-like target)
              MAIN_BRANCH_URL="https://github.com/${{ github.repository }}/tree/$DEFAULT_BRANCH"
              
              echo "‚úÖ Targeting main branch: $DEFAULT_BRANCH"
              echo "pull_request_url=$MAIN_BRANCH_URL" >> $GITHUB_OUTPUT
              echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "pr_number=" >> $GITHUB_OUTPUT
              echo "target_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
              echo "target_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
              echo "is_main_branch=true" >> $GITHUB_OUTPUT
              
            elif [[ "$TRIGGER_COMMAND" == "rc-api-review" ]]; then
              echo "üéØ RC review in issue - looking for PR URL"
              
              # For RC reviews in issues, extract PR URL from issue description
              ISSUE_BODY=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }} --jq '.body')
              
              # Extract PR URL from lines 3-4 (accounting for title and blank line)
              PR_URL=$(echo "$ISSUE_BODY" | sed -n '3,4p' | grep -E 'https://github\.com/[^/]+/[^/]+/pull/[0-9]+' | head -1)
              
              if [[ -z "$PR_URL" ]]; then
                echo "‚ùå No PR URL found in issue description for /rc-api-review"
                echo "Expected format: https://github.com/camaraproject/[repo]/pull/[number]"
                echo ""
                echo "Issue description should be formatted like:"
                echo "# Release Review for API v1.0.0"
                echo ""
                echo "https://github.com/camaraproject/MyAPI/pull/123"
                echo ""
                echo "üí° Use /wip-api-review if you want to review the main branch instead"
                exit 1
              fi
              
              echo "‚úÖ Found PR URL: $PR_URL"
              echo "pull_request_url=$PR_URL" >> $GITHUB_OUTPUT
              echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
              echo "pr_number=" >> $GITHUB_OUTPUT
              echo "target_branch=" >> $GITHUB_OUTPUT
              echo "target_repo=" >> $GITHUB_OUTPUT
              echo "is_main_branch=false" >> $GITHUB_OUTPUT
            fi
            
          elif [[ "$COMMENT_CONTEXT" == "pull_request" ]]; then
            echo "üîÄ Processing pull request comment..."
            
            # For PR comments, always use the current pull request
            PR_NUMBER="${{ github.event.issue.number }}"
            PR_URL="${{ github.event.issue.pull_request.html_url }}"
            
            echo "‚úÖ Using current PR: $PR_URL"
            echo "pull_request_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "issue_number=" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "target_branch=" >> $GITHUB_OUTPUT
            echo "target_repo=" >> $GITHUB_OUTPUT
            echo "is_main_branch=false" >> $GITHUB_OUTPUT
          fi
          
          # Set review type based on trigger command
          if [[ "$TRIGGER_COMMAND" == "rc-api-review" ]]; then
            REVIEW_TYPE="release-candidate"
          elif [[ "$TRIGGER_COMMAND" == "wip-api-review" ]]; then
            REVIEW_TYPE="wip"
          else
            REVIEW_TYPE="release-candidate"  # default
          fi
          
          echo "review_type=$REVIEW_TYPE" >> $GITHUB_OUTPUT
          echo "commonalities_version=0.6" >> $GITHUB_OUTPUT
          
          echo "üìù Final parameters:"
          echo "  Review Type: $REVIEW_TYPE"
          echo "  Commonalities Version: 0.6"
          echo "  Target: ${{ steps.extract.outputs.pull_request_url }}"
          echo "  Context: $COMMENT_CONTEXT"
          
          if [[ "$COMMENT_CONTEXT" == "issue" ]]; then
            echo "  Issue Number: ${{ github.event.issue.number }}"
            if [[ "${{ steps.extract.outputs.is_main_branch }}" == "true" ]]; then
              echo "  Special: Targeting main branch for WIP review"
            fi
          else
            echo "  PR Number: $PR_NUMBER"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Acknowledge Comment
        if: steps.check.outputs.should_run == 'true'
        run: |
          TRIGGER_COMMAND="${{ steps.check.outputs.trigger_command }}"
          COMMENT_CONTEXT="${{ steps.check.outputs.comment_context }}"
          REVIEW_TYPE="${{ steps.extract.outputs.review_type }}"
          
          # Create appropriate acknowledgment message
          if [[ "$TRIGGER_COMMAND" == "rc-api-review" ]]; then
            REVIEW_DESCRIPTION="Release Candidate Review"
            if [[ "$COMMENT_CONTEXT" == "issue" ]]; then
              REVIEW_CONTEXT="Pull Request: ${{ steps.extract.outputs.pull_request_url }}"
            else
              REVIEW_CONTEXT="Current Pull Request: ${{ steps.extract.outputs.pull_request_url }}"
            fi
          elif [[ "$TRIGGER_COMMAND" == "wip-api-review" ]]; then
            REVIEW_DESCRIPTION="Work-in-Progress Review"
            REVIEW_CONTEXT="Current Pull Request: ${{ steps.extract.outputs.pull_request_url }}"
          fi
          
          # Create acknowledgment comment
          cat > acknowledge_comment.md << EOF
          ü§ñ **$REVIEW_DESCRIPTION Triggered**
          
          Starting automated CAMARA API review...
          
          **Details:**
          - $REVIEW_CONTEXT
          - Review Type: $REVIEW_TYPE
          - Commonalities Version: 0.6
          - Repository: ${{ github.repository }}
          - Trigger: \`/$TRIGGER_COMMAND\`
          
          **Version Support:**
          - ‚úÖ Commonalities 0.6: Fully supported
          - ‚è≥ Commonalities 0.7+: Coming soon
          
          Results will be posted here when the review completes.
          EOF
          
          # Post comment to appropriate location
          COMMENT_JSON=$(jq -n --rawfile body acknowledge_comment.md '{body: $body}')
          
          if [[ "$COMMENT_CONTEXT" == "issue" ]]; then
            # Post to issue
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
              -d "$COMMENT_JSON"
            echo "‚úÖ Acknowledgment posted to issue #${{ github.event.issue.number }}"
          else
            # Post to pull request
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/issues/${{ steps.extract.outputs.pr_number }}/comments" \
              -d "$COMMENT_JSON"
            echo "‚úÖ Acknowledgment posted to pull request #${{ steps.extract.outputs.pr_number }}"
          fi

  validate-input:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'issue_comment' && needs.check-comment-trigger.outputs.should_run == 'true')
    needs: check-comment-trigger
    outputs:
      repo_owner: ${{ steps.parse.outputs.repo_owner }}
      repo_name: ${{ steps.parse.outputs.repo_name }}
      pr_number: ${{ steps.parse.outputs.pr_number }}
      pr_head_sha: ${{ needs.validate-input.outputs.final_pr_head_sha }}
      pr_head_ref: ${{ needs.validate-input.outputs.final_pr_head_ref }}
      pr_head_repo: ${{ needs.validate-input.outputs.final_pr_head_repo }}
      pr_base_ref: ${{ needs.validate-input.outputs.final_pr_base_ref }}
      pr_base_repo: ${{ needs.validate-input.outputs.final_pr_base_repo }}
      pull_request_url: ${{ steps.determine-inputs.outputs.pull_request_url }}
      issue_number: ${{ steps.determine-inputs.outputs.issue_number }}
      review_type: ${{ steps.determine-inputs.outputs.review_type }}
      commonalities_version: ${{ steps.determine-inputs.outputs.commonalities_version }}
      tooling_repo: ${{ steps.discover-tooling.outputs.tooling_repo }}
      tooling_version: ${{ steps.discover-tooling.outputs.tooling_version }}
      workflow_location: ${{ steps.discover-tooling.outputs.workflow_location }}
      tooling_version: ${{ steps.discover-tooling.outputs.tooling_version }}
      final_pr_head_sha: ${{ steps.final-outputs.outputs.final_pr_head_sha }}
      final_pr_head_ref: ${{ steps.final-outputs.outputs.final_pr_head_ref }}
      final_pr_head_repo: ${{ steps.final-outputs.outputs.final_pr_head_repo }}
      final_pr_base_ref: ${{ steps.final-outputs.outputs.final_pr_base_ref }}
      final_pr_base_repo: ${{ steps.final-outputs.outputs.final_pr_base_repo }}
    steps:
      - name: Determine Input Source
        id: determine-inputs
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "üìù Using inputs from comment trigger"
            echo "pull_request_url=${{ needs.check-comment-trigger.outputs.pull_request_url }}" >> $GITHUB_OUTPUT
            echo "issue_number=${{ needs.check-comment-trigger.outputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "review_type=${{ needs.check-comment-trigger.outputs.review_type }}" >> $GITHUB_OUTPUT
            echo "commonalities_version=${{ needs.check-comment-trigger.outputs.commonalities_version }}" >> $GITHUB_OUTPUT
          else
            echo "üìù Using inputs from manual dispatch"
            echo "pull_request_url=${{ github.event.inputs.pull_request_url }}" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
            echo "review_type=${{ github.event.inputs.review_type }}" >> $GITHUB_OUTPUT
            echo "commonalities_version=${{ github.event.inputs.commonalities_version }}" >> $GITHUB_OUTPUT
          fi

      - name: Parse Pull Request URL or Main Branch
        id: parse
        run: |
          PR_URL="${{ steps.determine-inputs.outputs.pull_request_url }}"
          IS_MAIN_BRANCH="${{ steps.determine-inputs.outputs.is_main_branch }}"
          
          echo "üîç Parsing target: $PR_URL"
          echo "Is main branch: $IS_MAIN_BRANCH"
          
          if [[ "$IS_MAIN_BRANCH" == "true" ]]; then
            echo "üåø Processing main branch target"
            
            # For main branch, use the current repository
            REPO_OWNER="${{ github.repository_owner }}"
            REPO_NAME="${{ github.repository }}"
            REPO_NAME="${REPO_NAME#*/}"  # Remove owner prefix
            
            # Get the default branch and latest commit
            DEFAULT_BRANCH="${{ steps.determine-inputs.outputs.target_branch }}"
            LATEST_SHA=$(gh api repos/${{ github.repository }}/commits/$DEFAULT_BRANCH --jq '.sha')
            
            echo "‚úÖ Main branch target parsed:"
            echo "  Owner: $REPO_OWNER"
            echo "  Repository: $REPO_NAME"
            echo "  Branch: $DEFAULT_BRANCH"
            echo "  Latest SHA: $LATEST_SHA"
            
            echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
            echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
            echo "pr_head_sha=$LATEST_SHA" >> $GITHUB_OUTPUT
            echo "pr_head_ref=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
            echo "pr_head_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "pr_base_ref=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
            echo "pr_base_repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            
          else
            echo "üîó Processing pull request URL"
            
            # Extract components using regex
            if [[ "$PR_URL" =~ ^https://github\.com/([^/]+)/([^/]+)/pull/([0-9]+)$ ]]; then
              REPO_OWNER="${BASH_REMATCH[1]}"
              REPO_NAME="${BASH_REMATCH[2]}"
              PR_NUMBER="${BASH_REMATCH[3]}"
              
              echo "‚úÖ Successfully parsed PR URL:"
              echo "  Owner: $REPO_OWNER"
              echo "  Repository: $REPO_NAME"
              echo "  PR Number: $PR_NUMBER"
              
              echo "repo_owner=$REPO_OWNER" >> $GITHUB_OUTPUT
              echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
              echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Invalid PR URL format: $PR_URL"
              echo "Expected format: https://github.com/[owner]/[repo]/pull/[number]"
              exit 1
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Pull Request Details
        id: pr_details
        if: steps.determine-inputs.outputs.is_main_branch != 'true'
        run: |
          REPO_OWNER="${{ steps.parse.outputs.repo_owner }}"
          REPO_NAME="${{ steps.parse.outputs.repo_name }}"
          PR_NUMBER="${{ steps.parse.outputs.pr_number }}"
          
          echo "üîç Fetching PR details for $REPO_OWNER/$REPO_NAME#$PR_NUMBER"
          
          # Get PR details using GitHub API
          PR_DATA=$(gh api repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER)
          
          # Extract required information
          PR_HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          PR_HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          PR_HEAD_REPO=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
          PR_BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')
          PR_BASE_REPO=$(echo "$PR_DATA" | jq -r '.base.repo.full_name')
          PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
          
          echo "‚úÖ PR Details:"
          echo "  State: $PR_STATE"
          echo "  Head SHA: $PR_HEAD_SHA"
          echo "  Head Ref: $PR_HEAD_REF"
          echo "  Head Repo: $PR_HEAD_REPO"
          echo "  Base Ref: $PR_BASE_REF"
          echo "  Base Repo: $PR_BASE_REPO"
          
          # Validate PR state
          if [[ "$PR_STATE" != "open" ]]; then
            echo "‚ö†Ô∏è Warning: PR is not open (state: $PR_STATE)"
            echo "Review will proceed but results may not be relevant"
          fi
          
          echo "pr_head_sha=$PR_HEAD_SHA" >> $GITHUB_OUTPUT
          echo "pr_head_ref=$PR_HEAD_REF" >> $GITHUB_OUTPUT
          echo "pr_head_repo=$PR_HEAD_REPO" >> $GITHUB_OUTPUT
          echo "pr_base_ref=$PR_BASE_REF" >> $GITHUB_OUTPUT
          echo "pr_base_repo=$PR_BASE_REPO" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Final Outputs
        id: final-outputs
        run: |
          # Use PR details if available, otherwise use main branch details
          if [[ "${{ steps.determine-inputs.outputs.is_main_branch }}" == "true" ]]; then
            echo "Using main branch details"
            echo "final_pr_head_sha=${{ steps.parse.outputs.pr_head_sha }}" >> $GITHUB_OUTPUT
            echo "final_pr_head_ref=${{ steps.parse.outputs.pr_head_ref }}" >> $GITHUB_OUTPUT
            echo "final_pr_head_repo=${{ steps.parse.outputs.pr_head_repo }}" >> $GITHUB_OUTPUT
            echo "final_pr_base_ref=${{ steps.parse.outputs.pr_base_ref }}" >> $GITHUB_OUTPUT
            echo "final_pr_base_repo=${{ steps.parse.outputs.pr_base_repo }}" >> $GITHUB_OUTPUT
          else
            echo "Using PR details"
            echo "final_pr_head_sha=${{ steps.pr_details.outputs.pr_head_sha }}" >> $GITHUB_OUTPUT
            echo "final_pr_head_ref=${{ steps.pr_details.outputs.pr_head_ref }}" >> $GITHUB_OUTPUT
            echo "final_pr_head_repo=${{ steps.pr_details.outputs.pr_head_repo }}" >> $GITHUB_OUTPUT
            echo "final_pr_base_ref=${{ steps.pr_details.outputs.pr_base_ref }}" >> $GITHUB_OUTPUT
            echo "final_pr_base_repo=${{ steps.pr_details.outputs.pr_base_repo }}" >> $GITHUB_OUTPUT
          fi

      - name: Discover Tooling Repository
        id: discover-tooling
        run: |
          echo "üîç Discovering tooling repository location..."
          echo "Repository Owner: ${{ github.repository_owner }}"
          
          # Default values
          TOOLING_REPO="camaraproject/tooling"
          TOOLING_VERSION="main"
          
          # Try fork's tooling first if not camaraproject
          if [[ "${{ github.repository_owner }}" != "camaraproject" ]]; then
            FORK_TOOLING="${{ github.repository_owner }}/tooling"
            echo "üîç Checking fork tooling: $FORK_TOOLING"
            
            # Check if fork's tooling repository exists and has the workflow
            if gh api repos/$FORK_TOOLING/contents/.github/workflows/api-review-reusable.yml &>/dev/null; then
              echo "‚úÖ Found fork tooling repository: $FORK_TOOLING"
              TOOLING_REPO="$FORK_TOOLING"
            else
              echo "‚ÑπÔ∏è Fork tooling not found, using official: $TOOLING_REPO"
            fi
          else
            echo "‚ÑπÔ∏è Using official tooling repository: $TOOLING_REPO"
          fi
          
          # Verify the chosen tooling repository exists
          if ! gh api repos/$TOOLING_REPO/contents/.github/workflows/api-review-reusable.yml &>/dev/null; then
            echo "‚ùå ERROR: Reusable workflow not found at $TOOLING_REPO"
            echo "Expected location: $TOOLING_REPO/.github/workflows/api-review-reusable.yml"
            echo ""
            echo "Please ensure:"
            echo "  1. The tooling repository exists and is accessible"
            echo "  2. The api-review-reusable.yml workflow file exists"
            echo "  3. You have read access to the tooling repository"
            exit 1
          fi
          
          WORKFLOW_LOCATION="$TOOLING_REPO/.github/workflows/api-review-reusable.yml"
          
          echo "tooling_repo=$TOOLING_REPO" >> $GITHUB_OUTPUT
          echo "tooling_version=$TOOLING_VERSION" >> $GITHUB_OUTPUT
          echo "workflow_location=$WORKFLOW_LOCATION" >> $GITHUB_OUTPUT
          
          echo "üéØ Tooling Discovery Results:"
          echo "  Tooling Repository: $TOOLING_REPO"
          echo "  Tooling Version: $TOOLING_VERSION"
          echo "  Workflow Path: $WORKFLOW_LOCATION"
          echo "  Full Reference: $WORKFLOW_LOCATION@$TOOLING_VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  call-review-workflow:
    needs: validate-input
    if: always() && needs.validate-input.result == 'success'
    uses: ${{ needs.validate-input.outputs.workflow_location }}@${{ needs.validate-input.outputs.tooling_version }}
    with:
      repo_owner: ${{ needs.validate-input.outputs.repo_owner }}
      repo_name: ${{ needs.validate-input.outputs.repo_name }}
      pr_number: ${{ needs.validate-input.outputs.pr_number }}
      pr_head_sha: ${{ needs.validate-input.outputs.pr_head_sha }}
      pr_head_ref: ${{ needs.validate-input.outputs.pr_head_ref }}
      pr_head_repo: ${{ needs.validate-input.outputs.pr_head_repo }}
      pr_base_ref: ${{ needs.validate-input.outputs.pr_base_ref }}
      pr_base_repo: ${{ needs.validate-input.outputs.pr_base_repo }}
      review_type: ${{ needs.validate-input.outputs.review_type }}
      commonalities_version: ${{ needs.validate-input.outputs.commonalities_version }}
      issue_number: ${{ needs.validate-input.outputs.issue_number }}
      pr_number_for_comment: ${{ needs.validate-input.outputs.pr_number_for_comment }}
      result_target: ${{ needs.validate-input.outputs.result_target }}
    secrets: inherit

  post-results:
    runs-on: ubuntu-latest
    needs: [call-review-workflow, validate-input]
    if: always() && needs.call-review-workflow.result != 'skipped'
    steps:
      - name: Post Review Results
        if: needs.call-review-workflow.result == 'success'
        run: |
          echo "üìä Posting review results..."
          
          RESULT_TARGET="${{ needs.validate-input.outputs.result_target }}"
          
          # Get summary content from reusable workflow
          SUMMARY_CONTENT="${{ needs.call-review-workflow.outputs.summary_content }}"
          REVIEW_STATUS="${{ needs.call-review-workflow.outputs.review_status }}"
          CRITICAL_ISSUES="${{ needs.call-review-workflow.outputs.critical_issues_count }}"
          
          # Determine trigger information
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ "${{ needs.validate-input.outputs.is_main_branch }}" == "true" ]]; then
              TRIGGER_INFO="**Triggered by**: Comment \`/wip-api-review\` by @${{ github.event.comment.user.login }}"
            else
              TRIGGER_COMMAND="${{ needs.check-comment-trigger.outputs.trigger_command }}"
              TRIGGER_INFO="**Triggered by**: Comment \`/$TRIGGER_COMMAND\` by @${{ github.event.comment.user.login }}"
            fi
          else
            TRIGGER_INFO="**Triggered by**: Manual workflow dispatch"
          fi
          
          # Create results content
          cat > results_content.md << EOF
          ## ‚úÖ API Review Complete
          
          ${TRIGGER_INFO}
          **Pull Request**: ${{ needs.validate-input.outputs.pull_request_url }}
          **Repository**: ${{ github.repository }}
          **Review Type**: ${{ needs.validate-input.outputs.review_type }}
          **Commonalities Version**: ${{ needs.validate-input.outputs.commonalities_version }}
          **Tooling Used**: ${{ needs.validate-input.outputs.tooling_repo }}
          **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### Review Summary
          
          $SUMMARY_CONTENT
          
          ### Next Steps
          
          EOF
          
          # Add status-specific guidance
          if [[ "$REVIEW_STATUS" == "success" ]]; then
            echo "üéâ **No critical issues found** - API is ready for release!" >> results_content.md
          elif [[ "$REVIEW_STATUS" == "has_critical_issues" ]]; then
            echo "‚ö†Ô∏è **$CRITICAL_ISSUES critical issue(s) found** - Please address before release." >> results_content.md
            echo "" >> results_content.md
            echo "1. Review the detailed report in the workflow artifacts" >> results_content.md
            echo "2. Fix all critical issues" >> results_content.md
            if [[ "${{ needs.validate-input.outputs.review_type }}" == "release-candidate" ]]; then
              echo "3. Re-run the review with \`/rc-api-review\`" >> results_content.md
            else
              echo "3. Re-run the review with \`/wip-api-review\`" >> results_content.md
            fi
          else
            echo "‚ùì **Review completed with warnings** - Please review the detailed report." >> results_content.md
          fi
          
          # Post results based on trigger type
          if [[ "$RESULT_TARGET" == "manual" ]]; then
            echo "üìù Posting results to workflow summary"
            
            # Post to workflow summary
            cat results_content.md >> $GITHUB_STEP_SUMMARY
            
            echo "‚úÖ Results posted to workflow summary"
          else
            echo "üìù Posting results to comment"
            
            # Determine where to post comment
            if [[ -n "${{ needs.validate-input.outputs.issue_number }}" ]]; then
              COMMENT_NUMBER="${{ needs.validate-input.outputs.issue_number }}"
              echo "Posting to issue #$COMMENT_NUMBER"
            else
              COMMENT_NUMBER="${{ needs.validate-input.outputs.pr_number_for_comment }}"
              echo "Posting to pull request #$COMMENT_NUMBER"
            fi
            
            # Post comment (works for both issues and PRs)
            COMMENT_JSON=$(jq -n --rawfile body results_content.md '{body: $body}')
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/issues/${COMMENT_NUMBER}/comments" \
              -d "$COMMENT_JSON"
            
            echo "‚úÖ Results posted to comment #${COMMENT_NUMBER}"
          fi

      - name: Handle Workflow Failure
        if: needs.call-review-workflow.result == 'failure'
        run: |
          echo "‚ùå API Review workflow failed"
          
          RESULT_TARGET="${{ needs.validate-input.outputs.result_target }}"
          
          # Determine trigger information
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            if [[ "${{ needs.validate-input.outputs.is_main_branch }}" == "true" ]]; then
              TRIGGER_INFO="**Triggered by**: Comment \`/wip-api-review\` by @${{ github.event.comment.user.login }}"
            else
              TRIGGER_COMMAND="${{ needs.check-comment-trigger.outputs.trigger_command }}"
              TRIGGER_INFO="**Triggered by**: Comment \`/$TRIGGER_COMMAND\` by @${{ github.event.comment.user.login }}"
            fi
          else
            TRIGGER_INFO="**Triggered by**: Manual workflow dispatch"
          fi
          
          # Create failure content
          cat > failure_content.md << EOF
          ## ‚ùå API Review Failed
          
          The automated API review encountered an error and could not complete.
          
          ${TRIGGER_INFO}
          **Pull Request**: ${{ needs.validate-input.outputs.pull_request_url }}
          **Repository**: ${{ github.repository }}
          **Review Type**: ${{ needs.validate-input.outputs.review_type }}
          **Commonalities Version**: ${{ needs.validate-input.outputs.commonalities_version }}
          **Tooling Used**: ${{ needs.validate-input.outputs.tooling_repo }}
          **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          **Error Details:**
          - Reusable workflow failed to execute
          - Check the workflow logs for detailed error information
          - This may be due to version compatibility, missing scripts, or GitHub Actions issues
          
          **Troubleshooting:**
          1. Verify Commonalities version is supported (currently: 0.6)
          2. Check that required validator scripts exist in tooling repository
          3. Review workflow logs for specific error messages
          4. Ensure API files exist in \`/code/API_definitions/\` directory
          
          Please check the workflow logs and retry the review.
          EOF
          
          # Post failure based on trigger type
          if [[ "$RESULT_TARGET" == "manual" ]]; then
            echo "üìù Posting failure to workflow summary"
            
            # Post to workflow summary
            cat failure_content.md >> $GITHUB_STEP_SUMMARY
            
            echo "‚úÖ Failure notification posted to workflow summary"
          else
            echo "üìù Posting failure to comment"
            
            # Determine where to post comment
            if [[ -n "${{ needs.validate-input.outputs.issue_number }}" ]]; then
              COMMENT_NUMBER="${{ needs.validate-input.outputs.issue_number }}"
              echo "Posting to issue #$COMMENT_NUMBER"
            else
              COMMENT_NUMBER="${{ needs.validate-input.outputs.pr_number_for_comment }}"
              echo "Posting to pull request #$COMMENT_NUMBER"
            fi
            
            # Post comment (works for both issues and PRs)
            COMMENT_JSON=$(jq -n --rawfile body failure_content.md '{body: $body}')
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${{ github.api_url }}/repos/${{ github.repository }}/issues/${COMMENT_NUMBER}/comments" \
              -d "$COMMENT_JSON"
            
            echo "‚úÖ Failure notification posted to comment #${COMMENT_NUMBER}"
          fi