# .github/workflows/api-review-reusable.yml
# 
# CAMARA API Review - Reusable Workflow
# 
# Purpose: Performs automated validation of CAMARA API definitions against compliance checklist.
#   - Checks out target repository PR branch
#   - Finds API YAML files in /code/API_definitions/  
#   - Runs comprehensive automated validation checks
#   - Generates detailed reports and issue summaries
# 
# Called by: api-review-trigger.yml workflow
# 
# Usage Guide: /documentation/SupportingDocuments/CAMARA_API_Review_Workflow_Usage_Guide.md
# Place this file in: ReleaseManagement repository .github/workflows/ directory

name: 'CAMARA API Review - Reusable'

on:
  workflow_call:
    inputs:
      repo_owner:
        required: true
        type: string
      repo_name:
        required: true
        type: string
      pr_number:
        required: true
        type: string
      pr_head_sha:
        required: true
        type: string
      pr_head_ref:
        required: true
        type: string
      review_type:
        required: true
        type: string
      commonalities_version:
        required: true
        type: string
      issue_number:
        required: true
        type: string

jobs:
  api-review:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Review Environment
        run: |
          echo "üöÄ Starting CAMARA API Review"
          echo "Repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}"
          echo "PR: #${{ inputs.pr_number }}"
          echo "Head SHA: ${{ inputs.pr_head_sha }}"
          echo "Review Type: ${{ inputs.review_type }}"
          echo "Expected Commonalities: ${{ inputs.commonalities_version }}"
          echo "Workflow Repository: ${{ github.repository }}"

      - name: Checkout Workflow Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: review-tools

      - name: Checkout Target Repository PR
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo_owner }}/${{ inputs.repo_name }}
          ref: ${{ inputs.pr_head_sha }}
          path: target-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml jsonschema openapi-spec-validator requests

      - name: Locate API Validator Script
        run: |
          echo "üîç Looking for API validator script..."
          echo "Workflow repository: ${{ github.repository }}"
          echo "Expected script location: review-tools/scripts/api_review_validator.py"
          
          # Check if the script exists in the checked-out workflow repository
          if [[ -f "review-tools/scripts/api_review_validator.py" ]]; then
            echo "‚úÖ Found validator script in workflow repository"
            cp review-tools/scripts/api_review_validator.py ./
          else
            echo "‚ùå API Validator script not found!"
            echo ""
            echo "Expected location: review-tools/scripts/api_review_validator.py"
            echo "Workflow repository: ${{ github.repository }}"
            echo ""
            echo "üìÅ Checking directory structure:"
            if [[ -d "review-tools" ]]; then
              echo "review-tools directory contents:"
              find review-tools -type f -name "*.py" | head -10 || echo "No Python files found"
              echo ""
              echo "review-tools/scripts directory contents:"
              ls -la review-tools/scripts/ 2>/dev/null || echo "scripts directory not found"
            else
              echo "review-tools directory does not exist"
            fi
            echo ""
            echo "Please ensure the api_review_validator.py script exists at:"
            echo "  ${{ github.repository }}/scripts/api_review_validator.py"
            exit 1
          fi
          
          # Make script executable
          chmod +x api_review_validator.py
          
          # Verify the script is working
          echo "üß™ Testing validator script..."
          if python api_review_validator.py 2>&1 | grep -q "Usage:" || [[ $? -eq 1 ]]; then
            echo "‚úÖ Validator script is accessible"
          else
            echo "‚ö†Ô∏è Validator script may have issues, but continuing..."
          fi

      - name: Run API Review
        id: review
        run: |
          echo "üîç Searching for API definition files..."
          
          # Create output directory
          mkdir -p ./review-output
          
          # Debug: Check target repository structure
          echo "üìÅ Target repository structure:"
          find target-repo -type f -name "*.yaml" -o -name "*.yml" | head -10 || echo "No YAML files found"
          
          # Run the validation
          echo "üöÄ Starting validation..."
          python api_review_validator.py "./target-repo" "${{ inputs.commonalities_version }}" "./review-output"
          
          # Capture exit code
          VALIDATION_EXIT_CODE=$?
          
          # Set output for next steps
          if [ $VALIDATION_EXIT_CODE -eq 0 ]; then
            echo "review_status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ API review completed successfully"
          else
            echo "review_status=failed" >> $GITHUB_OUTPUT
            echo "‚ùå API review found critical issues (exit code: $VALIDATION_EXIT_CODE)"
          fi

      - name: Upload Detailed Report
        uses: actions/upload-artifact@v4
        with:
          name: api-review-detailed-report
          path: ./review-output/detailed-report.md
          retention-days: 30

      - name: Upload Summary for Comment
        uses: actions/upload-artifact@v4
        with:
          name: api-review-summary
          path: ./review-output/summary.md
          retention-days: 7

      - name: Display Review Summary
        run: |
          echo "## üìã API Review Summary"
          if [ -f "./review-output/summary.md" ]; then
            cat ./review-output/summary.md
          else
            echo "‚ùå Summary file not generated"
          fi

      - name: Fail on Critical Issues
        if: steps.review.outputs.review_status == 'failed'
        run: |
          echo "‚ùå API review found critical issues that must be addressed"
          echo "Please download the detailed report and review all findings"
          exit 1